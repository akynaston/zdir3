2/8/2024 10:26:42 PM
/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package org.idmunit.connector;

import org.idmunit.IdMUnitException;
import org.junit.Before;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockedConstruction;
import org.mockito.Mockito;
import org.mockito.invocation.InvocationOnMock;
import org.mockito.stubbing.Answer;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Text;

import javax.inject.Inject;
import javax.jms.*;
import javax.naming.InitialContext;
import java.util.*;

import static org.mockito.Mockito.*;


//@InjectMocks


class MCLConnectorTest {
    MCLConnector mclConnector = null;
    private static final Logger LOGGER = LoggerFactory.getLogger(MCLConnectorTest.class);
    @BeforeEach
    void setup() throws IdMUnitException {
        Map<String, String> config = new HashMap<>();
        mclConnector = new MCLConnector();
        config = new HashMap<>();
        // we're setting up a mock; but we want the connector to avoid throwing errors; so we'll at least put place holder data in the config:
        config.put(MCLConnector.CONFIG_URL, "FAKE URL ENDPOINT");
        config.put(MCLConnector.CONFIG_USER, "FAKE USER");
        config.put(MCLConnector.CONFIG_PASSWORD, "FAKE PASSWORD");
        config.put(MCLConnector.CONFIG_SUBJECT, "FAKE SUBJECT");
        config.put(MCLConnector.CONFIG_CONN_FACTORY_JNDI_NAME, "FAKE CON FACTORY NAME");

        // Mock every portion of the JMS components:
        ConnectionFactory connFactoryMock = Mockito.mock(ConnectionFactory.class);
        Connection connMock = Mockito.mock(Connection.class);

        MockedConstruction<InitialContext> contextMock = Mockito.mockConstruction(InitialContext.class, (mock, context)-> {
            when(mock.lookup("FAKE CON FACTORY NAME")).thenReturn(connFactoryMock);
        });

        try {
            when(connFactoryMock.createConnection("FAKE USER", "FAKE PASSWORD")).thenReturn(connMock);

            Session mockSession = Mockito.mock(Session.class);
            when(connMock.createSession(false, Session.AUTO_ACKNOWLEDGE)).thenReturn(mockSession);

            Topic mockTopic = Mockito.mock(Topic.class);
            MessageConsumer mockMessageConsumerSubscriber = Mockito.mock(MessageConsumer.class);

            when(mockSession.createTopic("FAKE SUBJECT")).thenReturn(mockTopic);
            when(mockSession.createConsumer(mockTopic)).thenReturn(mockMessageConsumerSubscriber);

            
            doAnswer(new Answer<Void>() {
                public Void answer(InvocationOnMock invocation) {
                    Object[] args = invocation.getArguments();
                    //System.out.println("called with arguments: " + Arrays.toString(args));
                    return null;
                }
            }).when(mockMessageConsumerSubscriber).setMessageListener(mclConnector);



        } catch (JMSException e) {
            throw new IdMUnitException("Had Exception while setting up JMS mock", e);
        }





        /*

        try(MockedConstruction<PaymentService> mockPaymentService = Mockito.mockConstruction(PaymentService.class,(mock,context)-> {
            when(mock.processPayment()).thenReturn("Credit");
        })){
            PaymentProcessor paymentProcessor = new PaymentProcessor();
            Assertions.assertEquals(1,mockPaymentService.constructed().size());
            Assertions.assertEquals("Credit", paymentProcessor.processPayment());
        }
        //JtdsStatement jtdsStatement = Mockito.mock(JtdsStatement.class);
        ResultSet resultSetMock = Mockito.mock(ResultSet.class);
        Mockito.when(resultSetMock.getString("RES_USER_ID")).thenReturn("E99913");
        Mockito.when(resultSetMock.getString("OFC_ID")).thenReturn("ABQWN01CS");
        Mockito.when(resultSetMock.getDate("EXPR_UTC_DT")).thenReturn(new java.sql.Date(System.currentTimeMillis()));
        Mockito.when(resultSetMock.getString("SIGN_ID")).thenReturn("0037TT");

        // Emulate the results from the user table:
        Mockito.when(resultSetMock.getString("FRST_NME_TXT")).thenReturn("T1ABQ1CS");
        Mockito.when(resultSetMock.getString("LST_NME_TXT")).thenReturn("LAST3");

        Connection connectionMock = Mockito.mock(Connection.class);
        Mockito.doReturn(jtdsStatement).when(connectionMock).createStatement();

        // ensure .next returns true when called on the first statement on the OFC table, then true again on the user table to provide results for both.
        Mockito.when(resultSetMock.next()).thenReturn(true).thenReturn(true).thenReturn(false);
        Mockito.doReturn(resultSetMock).when(jtdsStatement).executeQuery(Mockito.anyString());


*/
        try {
            mclConnector.setup(config);
        } catch (IdMUnitException e) {
            throw new IdMUnitException("Could not setup the test mcl connector.", e);
        }
    }

    @Test
    void testValidate() throws IdMUnitException {
        Map<String, Collection<String>> basicUser = new HashMap<>();

        String userID = "e123456";
        String messagePayload = userID + "AMessage to validate";

        basicUser.put(MCLConnector.USER_ID, Collections.singletonList(userID));
        basicUser.put(MCLConnector.MESSAGE, Collections.singletonList(messagePayload));
        TextMessage mockTextMessage = Mockito.mock(TextMessage.class);

        try {
            when(mockTextMessage.getText()).thenReturn(messagePayload);
        } catch (JMSException e) {
            throw new IdMUnitException("Failed mocking getText onTextMessage", e);
        }

        mclConnector.onMessage(mockTextMessage);


        // WORKING HERE: Need to mockup a Message, then get OnMessage triggered somehow . .
        mclConnector.opValidate(basicUser);
    }

}


